---
# json for ingest into search index
#
# add note to index full-text of all PDFs?
full-text: true
---
{%- assign items = site.data[site.metadata] | where_exp: 'item','item.objectid' -%}
{%- assign raw-dates = items | map: 'date' | compact | uniq -%}
{%- capture clean-years -%}{% for date in raw-dates %}{% if date contains "-" %}{{ date | strip | split: "-" | first }}{% elsif date contains "/" %}{{ date | strip | split: "/" | last }}{% else %}{{ date | strip }}{% endif %}{% unless forloop.last %};{% endunless %}{%- endfor -%}{%- endcapture -%}
{%- assign date-range = clean-years | remove: " " | split: ";" | uniq | sort  -%}
{%- assign formats = items | map: 'format' -%}
{%- assign formats_uniq = formats | uniq -%}
{%- assign fields = site.data.config-search-index -%}
{ 
    "collection": {
        "id": "{{ site.baseurl | slugify }}",
        "title": {{ site.title | jsonify }},
        "url": "{{ '/' | absolute_url }}",
        "image": "{{ site.data.featured_item.src | relative_url }}", 
        "description": "{{ site.description }}",
        {% if site.organization-name %}
        "publisher": { 
            "name": "{{ site.organization-name }}", 
            "url": "{{ site.organization-link }}", 
            "logo": "{{ site.organization-logo-banner }}" 
        },{% endif %}
        "date_start": "{{ date-range | first }}",
        "date_end": "{{ date-range | last }}",
        "objects": {
            {% for f in formats_uniq %}{% assign count = formats | where_exp: 'i', 'i contains f' | size %}{{ f | jsonify }}: "{{ count }}"{% unless forloop.last %},{% endunless %}
            {% endfor %}
        },
        "data": "{{ '/assets/data/datapackage.json' | absolute_url }}",
        "last_build_date": "{{ site.time | date: '%Y-%m-%d' }}"
        },
    "items":    
        [
            {%- for item in items -%}
            { 
                {% for f in fields %}{% if item[f.field] %}{{ f.dcterm | jsonify }}: {{ item[f.field] | jsonify }},{% endif %}
                {% endfor %}
                {% if item.image_thumb %}"thumb": "{{ item.image_thumb | absolute_url }}",{% endif %}
                {% if item.object_transcript %}"transcript": {% assign transcript_type = page.object_transcript | slice: 0,8 %}{% if transcript_type == 'objects/' %}{% assign transcript = site.pages | where: 'path',page.object_transcript | first %}{{ transcript.content | markdownify | jsonify }}{% else %}{{ page.object_transcript | markdownify | jsonfiy }}{% endif %},{% endif %}
                {% if item.object_location %}"file": "{{ item.object_location | absolute_url }}",{% endif %}
                {% if full-text == true and item.format contains 'pdf' %}"text": true,{% elsif item.full-text == true %}"text": true,{% endif %}
                "collectionid": "{{ site.baseurl | slugify }}",
                "objectid": "{% if item.parentid %}{{ item.parentid }}#{% endif %}{{ item.objectid }}",
                "url": "{{ '/items/' | absolute_url }}{% if item.parentid %}{{ item.parentid }}.html#{{ item.objectid }}{% else %}{{ item.objectid }}.html{% endif %}"
            }{% unless forloop.last %},{% endunless %}
            {% endfor %}
        ] 
}
